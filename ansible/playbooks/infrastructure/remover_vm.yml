---
- name: Listar e remover VMs cadastradas
  hosts: localhost
  gather_facts: false

  collections:
    - community.general

  vars_files:
    - ../../vault/proxmox_access.yml
    - ../../group_vars/all_{{ env | default('dev') }}.yml

  vars:
    proxmox_api_user_full: "{{ proxmox_user }}@{{ proxmox_realm }}"
    target_vm_name: "{{ vm_name | default('') }}"
    proxmox_debug_auth: false

  tasks:
    - name: Listar VMs cadastradas
      ansible.builtin.debug:
        msg: |
          VMs conhecidas:
          {% for vm in proxmox_vms %}
          - {{ vm.name }} (vmid={{ vm.vmid | default('auto') }}, tags={{ vm.tags | default('sem') }}, node={{ vm.node }})
          {% endfor %}

    - name: Validar nome informado
      ansible.builtin.assert:
        that:
          - target_vm_name | length > 0
        fail_msg: "Informe a VM alvo passando --extra-vars vm_name=<nome>"

    - name: Selecionar VM alvo
      ansible.builtin.set_fact:
        target_vms: "{{ proxmox_vms | selectattr('name', 'equalto', target_vm_name) | list }}"

    - name: Validar VM encontrada
      ansible.builtin.assert:
        that:
          - target_vms | length > 0
        fail_msg: "Nenhuma VM chamada {{ target_vm_name }} encontrada em proxmox_vms"

    - name: Usar primeira correspondência como alvo
      ansible.builtin.set_fact:
        target_vm: "{{ target_vms[0] }}"

    - name: Consultar VM no Proxmox para obter vmid quando ausente
      community.general.proxmox_vm_info:
        api_host: "{{ proxmox_api_host }}"
        api_user: "{{ proxmox_api_user_full }}"
        api_token_id: "{{ proxmox_token_name }}"
        api_token_secret: "{{ proxmox_token_secret }}"
        validate_certs: "{{ proxmox_validate_certs | default(false) }}"
      register: vm_info
      when: target_vm.vmid is not defined

    - name: Definir vmid obtido via API
      ansible.builtin.set_fact:
        target_vm_vmid: "{{ (vm_info.proxmox_vms | selectattr('name', 'equalto', target_vm.name) | list | first).vmid }}"
      when: target_vm.vmid is not defined

    - name: Garantir que vmid está definido para remoção
      ansible.builtin.assert:
        that:
          - target_vm.vmid is defined or target_vm_vmid is defined
        fail_msg: "Defina o vmid da VM {{ target_vm_name }} em proxmox_vms antes de apagar"

    - name: Determinar se requer confirmação
      ansible.builtin.set_fact:
        requires_confirm: "{{ 'prod' in (target_vm.tags | default('')) or 'template' in (target_vm.tags | default('')) }}"

    - name: Solicitar confirmação para VMs com tag prod ou template
      ansible.builtin.pause:
        prompt: "A VM {{ target_vm_name }} possui tag protegida ({{ target_vm.tags | default('sem tags') }}). Digite 'confirm' para prosseguir com a exclusão:"
      register: prod_confirmation
      when: requires_confirm

    - name: Validar confirmação digitada
      ansible.builtin.assert:
        that:
          - not requires_confirm or prod_confirmation.user_input == 'confirm'
        fail_msg: "Remoção cancelada. Para VMs com tag prod ou template digite 'confirm'."

    - name: Exibir token utilizado para API
      ansible.builtin.debug:
        msg: "Token: {{ proxmox_api_user_full }}!{{ proxmox_token_name }}"
      when: proxmox_debug_auth | bool

    - name: Remover VM alvo
      community.general.proxmox_kvm:
        api_host: "{{ proxmox_api_host }}"
        api_user: "{{ proxmox_api_user_full }}"
        api_token_id: "{{ proxmox_token_name }}"
        api_token_secret: "{{ proxmox_token_secret }}"
        validate_certs: "{{ proxmox_validate_certs | default(false) }}"
        node: "{{ target_vm.node }}"
        vmid: "{{ target_vm.vmid | default(target_vm_vmid) }}"
        state: absent
        force: true
        timeout: 300
      register: removal_result

    - name: Mostrar resultado da remoção
      ansible.builtin.debug:
        var: removal_result
