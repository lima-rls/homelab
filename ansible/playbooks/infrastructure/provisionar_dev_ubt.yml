---
- name: Provisionar VM de desenvolvimento no Proxmox
  hosts: localhost
  gather_facts: false

  collections:
    - community.general

  vars_files:
    - ../../vault/proxmox_access.yml
    - ../../group_vars/all_{{ env | default('dev') }}.yml

  vars:
    proxmox_api_user_full: "{{ proxmox_user }}@{{ proxmox_realm }}"
    proxmox_api_token_id_full: "{{ proxmox_api_user_full }}!{{ proxmox_token_name }}"
    proxmox_debug_auth: false

  tasks:
    - name: Selecionar apenas dev-server
      ansible.builtin.set_fact:
        target_vms: "{{ proxmox_vms | selectattr('name', 'equalto', 'dev-server') | list }}"

    - name: Validar VM encontrada
      ansible.builtin.assert:
        that:
          - target_vms | length > 0
        fail_msg: "VM dev-server não encontrada em proxmox_vms"

    - name: Exibir token utilizado para API
      ansible.builtin.debug:
        msg: "Token: {{ proxmox_api_token_id_full }}"
      when: proxmox_debug_auth | bool

    - name: Garantir VM de desenvolvimento presente
      community.general.proxmox_kvm:
        api_host: "{{ proxmox_api_host }}"
        api_user: "{{ proxmox_api_user_full }}"
        api_token_id: "{{ proxmox_token_name }}"
        api_token_secret: "{{ proxmox_token_secret }}"
        validate_certs: "{{ proxmox_validate_certs | default(false) }}"
        node: "{{ item.node }}"
        vmid: "{{ item.vmid | default(omit) }}"
        name: "{{ item.name }}"
        clone: "{{ item.template }}"
        full: true
        cores: "{{ item.cores }}"
        memory: "{{ item.memory_mb }}"
        balloon: "{{ item.balloon | default(omit) }}"
        sockets: 1
        cpu: "{{ item.cpu | default(omit) }}"
        scsi: "scsi0={{ item.storage | default('local-lvm') }}:{{ item.disk_gb }}G"
        net: "net0={{ item.net0 | default('virtio,bridge=vmbr0') }}"
        ipconfig:
          ipconfig0: "{{ item.ipconfig0 if item.ipconfig0 is defined else omit }}"
        nameservers: "{{ item.nameservers if item.nameservers is defined else omit }}"
        tags: "{{ item.tags | default('') }}"
        description: "{{ item.description | default('') }}"
        onboot: true
        agent: 1
        state: present
        timeout: 300
        force: false
      register: vm_created
      loop: "{{ target_vms }}"
      loop_control:
        label: "{{ item.name }}"

    - name: Aguardar propagação da VM
      ansible.builtin.pause:
        seconds: 3

    - name: Configurar rede via API (atualizar VM existente)
      community.general.proxmox_kvm:
        api_host: "{{ proxmox_api_host }}"
        api_user: "{{ proxmox_api_user_full }}"
        api_token_id: "{{ proxmox_token_name }}"
        api_token_secret: "{{ proxmox_token_secret }}"
        validate_certs: "{{ proxmox_validate_certs | default(false) }}"
        node: "{{ item.node }}"
        name: "{{ item.name }}"
        ipconfig:
          ipconfig0: "{{ item.ipconfig0 if item.ipconfig0 is defined else omit }}"
        nameservers: "{{ item.nameservers if item.nameservers is defined else omit }}"
        state: present
        update: true
      register: vm_updated
      loop: "{{ target_vms }}"
      loop_control:
        label: "{{ item.name }}"
      when: item.ipconfig0 is defined

    - name: Iniciar VM para validação básica
      community.general.proxmox_kvm:
        api_host: "{{ proxmox_api_host }}"
        api_user: "{{ proxmox_api_user_full }}"
        api_token_id: "{{ proxmox_token_name }}"
        api_token_secret: "{{ proxmox_token_secret }}"
        validate_certs: "{{ proxmox_validate_certs | default(false) }}"
        node: "{{ item.node }}"
        name: "{{ item.name }}"
        state: started
        timeout: 300
      loop: "{{ target_vms }}"
      loop_control:
        label: "{{ item.name }}"

    - name: Aguardar boot completo
      ansible.builtin.pause:
        seconds: 45
        prompt: "Aguardando boot completo da VM..."

    - name: Exibir informações finais
      ansible.builtin.debug:
        msg: "VM {{ item.name }} provisionada e iniciada. IP: {{ item.ipconfig0.split(',')[0].split('=')[1] if item.ipconfig0 is defined else 'DHCP' }}"
      loop: "{{ target_vms }}"
      loop_control:
        label: "{{ item.name }}"


