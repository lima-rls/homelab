---
- name: Preparar template Ubuntu cloud-init no Proxmox
  hosts: proxmox
  gather_facts: false

  vars:
    template_vmid: 9000
    template_name: TEMPLATE-UBT-SERVER
    template_storage: local-lvm
    template_cores: 2
    template_memory: 1024
    template_disk_size: 32
    template_image_url: "https://cloud-images.ubuntu.com/noble/current/noble-server-cloudimg-amd64.img"
    template_image_filename: "noble-server-cloudimg-amd64.img"
    template_image_path: "/var/lib/vz/template/iso/{{ template_image_filename }}"
    ciuser: ubuntu
    ssh_public_key_file: ~/.ssh/id_rsa.pub

  tasks:
    - name: Verificar se template já existe
      ansible.builtin.command: "qm status {{ template_vmid }}"
      register: template_check
      failed_when: false
      changed_when: false

    - name: BLOCO 1 - Criar template
      when: template_check.rc != 0
      block:
        - name: Verificar se imagem cloud existe localmente
          ansible.builtin.stat:
            path: "{{ template_image_path }}"
          register: image_stat

        - name: Baixar imagem cloud Ubuntu (cache local)
          ansible.builtin.get_url:
            url: "{{ template_image_url }}"
            dest: "{{ template_image_path }}"
            mode: '0644'
          when: not image_stat.stat.exists

        - name: Criar VM base
          ansible.builtin.command: >
            qm create {{ template_vmid }}
            --name {{ template_name }}
            --memory {{ template_memory }}
            --cores {{ template_cores }}
            --net0 virtio,bridge=vmbr0
            --scsihw virtio-scsi-pci

        - name: Importar disco da imagem cloud
          ansible.builtin.command: >
            qm importdisk {{ template_vmid }} {{ template_image_path }} {{ template_storage }}
          register: import_result

        - name: Configurar disco principal
          ansible.builtin.command: >
            qm set {{ template_vmid }}
            --scsi0 {{ template_storage }}:vm-{{ template_vmid }}-disk-0

        - name: Adicionar drive cloud-init
          ansible.builtin.command: >
            qm set {{ template_vmid }}
            --ide2 {{ template_storage }}:cloudinit

        - name: Configurar boot e console
          ansible.builtin.command: >
            qm set {{ template_vmid }}
            --boot c
            --bootdisk scsi0
            --serial0 socket
            --vga serial0

        - name: Habilitar qemu-guest-agent
          ansible.builtin.command: >
            qm set {{ template_vmid }}
            --agent enabled=1

        - name: Redimensionar disco
          ansible.builtin.command: >
            qm resize {{ template_vmid }} scsi0 {{ template_disk_size }}G
          when: template_disk_size > 10

        - name: Exibir progresso - template criado
          ansible.builtin.debug:
            msg: "✓ Template VM criado (VMID {{ template_vmid }})"

    - name: BLOCO 2 - Configurar cloud-init
      block:
        - name: Ler chave SSH pública local
          ansible.builtin.slurp:
            src: "{{ ssh_public_key_file }}"
          register: ssh_key_content
          delegate_to: localhost

        - name: Configurar usuário padrão cloud-init
          ansible.builtin.command: >
            qm set {{ template_vmid }} --ciuser {{ ciuser }}

        - name: Criar arquivo temporário com chave SSH
          ansible.builtin.copy:
            content: "{{ ssh_key_content.content | b64decode }}"
            dest: /tmp/sshkey_temp.pub
            mode: '0600'

        - name: Configurar chave SSH no template
          ansible.builtin.command: >
            qm set {{ template_vmid }} --sshkeys /tmp/sshkey_temp.pub

        - name: Remover arquivo temporário
          ansible.builtin.file:
            path: /tmp/sshkey_temp.pub
            state: absent

        - name: Regenerar imagem cloud-init
          ansible.builtin.command: >
            qm cloudinit update {{ template_vmid }}

        - name: Exibir progresso - cloud-init configurado
          ansible.builtin.debug:
            msg: "✓ Cloud-init configurado (usuário: {{ ciuser }}, SSH key: configurada)"

    - name: Converter em template (se não é template ainda)
      ansible.builtin.command: "qm template {{ template_vmid }}"
      register: template_convert
      failed_when: template_convert.rc not in [0, 1]
      changed_when: template_convert.rc == 0

    - name: Exibir sucesso final
      ansible.builtin.debug:
        msg: |
          ✓✓✓ Template {{ template_name }} (VMID {{ template_vmid }}) pronto para uso!
          
          Próximo passo: provisionar VMs via
          ansible-playbook ansible/playbooks/provisionar_dev_ubt.yml --ask-vault-pass

    - name: Template já existe
      ansible.builtin.debug:
        msg: "✓ Template {{ template_name }} (VMID {{ template_vmid }}) já existe"
      when: template_check.rc == 0
